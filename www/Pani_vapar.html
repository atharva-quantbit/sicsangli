<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>पाणी वापर संस्था</title>
    <link rel="shortcut icon" href="/assets/sicsangli/img/logo/maharashtra.png" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Template CSS -->
    <link rel="stylesheet" href="/assets/sicsangli/css/owl.carousel.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/fontawesome-all.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/simple-line-icons.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/animate.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/flaticon.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/video.min.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/lightbox.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/style.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/footer.css">
    <link rel="stylesheet" href="/assets/sicsangli/css/header2.css">

    <link rel="stylesheet" href="/assets/sicsangli/css/pani-vapar.css">
</head>
<body class="page-pani-vapar">
    <div id="preloader"></div>
    <div class="up">
        <a href="#" class="scrollup text-center"><i class="fas fa-chevron-up"></i></a>
    </div>

    <!-- Header -->
    <div id="header-placeholder"></div>

    <div class="main-content">
        <section id="breadcrumb" class="breadcrumb-section position-relative"
                 data-background="/assets/sicsangli/img/watr-level/water-use.jpeg">
            <div class="background_overlay"></div>
            <div class="container">
                <div class="breadcrumb-content headline">
                    <h2 class="breadcrumb-title">पाणी वापर संस्था</h2>
                    <div class="breadcrumb_item ul-li">
                        <ul class="breadcrumb">
                            <li class="breadcrumb-item"><a href="#">मुख्य पान</a></li>
                            <li class="breadcrumb-item active">निविदा माहिती</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Centered Content -->
        <div class="content-wrapper py-5">
            <button id="refresh-btn">Refresh Data</button>
            <div id="last-updated" class="last-updated"></div>

            <!-- Title from sheet -->
            <div id="title-container"></div>

            <div id="loading" class="loading">Loading data from Google Sheet...</div>
            <div id="error" class="error" style="display: none;"></div>

            <!-- Responsive Table -->
            <div id="table-container" style="display: none; margin: 40px 0;">
                <div class="table-responsive mx-auto" style="max-width: 1400px;">
                    <table id="data-table"></table>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div id="footer-placeholder"></div>

    <!-- Template JS -->
    <script src="/assets/sicsangli/js/jquery.min.js"></script>
    <script src="/assets/sicsangli/js/bootstrap.min.js"></script>
    <script src="/assets/sicsangli/js/popper.min.js"></script>
    <script src="/assets/sicsangli/js/owl.carousel.min.js"></script>
    <script src="/assets/sicsangli/js/jarallax.js"></script>
    <script src="/assets/sicsangli/js/jquery.magnific-popup.min.js"></script>
    <script src="/assets/sicsangli/js/appear.js"></script>
    <script src="/assets/sicsangli/js/isotope.pkgd.min.js"></script>
    <script src="/assets/sicsangli/js/masonry.pkgd.min.js"></script>
    <script src="/assets/sicsangli/js/imagesloaded.pkgd.min.js"></script>
    <script src="/assets/sicsangli/js/lightbox.js"></script>
    <script src="/assets/sicsangli/js/waypoints.min.js"></script>
    <script src="/assets/sicsangli/js/jquery.counterup.min.js"></script>
    <script src="/assets/sicsangli/js/tilt.jquery.min.js"></script>
    <script src="/assets/sicsangli/js/wow.min.js"></script>
    <script src="/assets/sicsangli/js/script.js"></script>
    <script src="/assets/sicsangli/js/gmap3.min.js"></script>
    <script async src="http://maps.google.com/maps/api/js?key=AIzaSyC61_QVqt9LAhwFdlQmsNwi5aUJy9B2SyA"></script>

    <!-- JavaScript inside HTML -->
    <script>
        // Load Header & Footer
        async function loadHeader() {
            try {
                const res = await fetch('header2.html');
                const data = await res.text();
                document.getElementById('header-placeholder').innerHTML = data;
                setTimeout(() => {
                    const header = document.getElementById('header-placeholder');
                    if (header && window.getComputedStyle(header).position === 'fixed') {
                        const headerHeight = header.offsetHeight || 80;
                        document.body.style.paddingTop = headerHeight + 'px';
                    }
                }, 100);
                const hamburger = document.querySelector('.hamburger');
                const navMenu = document.getElementById('nav-menu');
                if (hamburger && navMenu) {
                    const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
                    hamburger.addEventListener('click', () => {
                        hamburger.classList.toggle('open');
                        navMenu.classList.toggle('active');
                        document.body.classList.toggle('no-scroll');
                        if (navMenu.classList.contains('active')) {
                            document.body.style.paddingRight = scrollbarWidth + 'px';
                        } else {
                            document.body.style.paddingRight = '';
                        }
                    });
                    navMenu.querySelectorAll('a').forEach(link => {
                        link.addEventListener('click', () => {
                            if (window.innerWidth <= 992) {
                                navMenu.classList.remove('active');
                                hamburger.classList.remove('open');
                                document.body.classList.remove('no-scroll');
                                document.body.style.paddingRight = '';
                            }
                        });
                    });
                }
            } catch (err) {
                console.error("Header load error:", err);
            }
        }

        async function loadFooter() {
            try {
                const res = await fetch('footer.html');
                const data = await res.text();
                document.getElementById('footer-placeholder').innerHTML = data;
                setTimeout(() => {
                    const footer = document.getElementById('footer-placeholder');
                    if (footer && window.getComputedStyle(footer).position === 'fixed') {
                        const footerHeight = footer.offsetHeight || 100;
                        document.body.style.paddingBottom = footerHeight + 'px';
                    }
                }, 100);
            } catch (err) {
                console.error("Footer load error:", err);
            }
        }

        loadHeader();
        loadFooter();

        // Data Fetching
        const API_ENDPOINT = '/api/method/sicsangli.pani_vapar.get_sheet_data';

        function padRow(cells, totalColumns) {
            const padded = cells ? [...cells] : [];
            while (padded.length < totalColumns) padded.push('');
            return padded.slice(0, totalColumns);
        }

        function setResponsiveColumnWidths(table, totalColumns) {
            if (window.innerWidth > 768) {
                const width = (100 / totalColumns).toFixed(4) + '%';
                table.querySelectorAll('th, td').forEach(cell => {
                    cell.style.width = width;
                    cell.style.minWidth = width;
                });
            } else {
                table.querySelectorAll('th, td').forEach(cell => {
                    cell.style.width = '';
                    cell.style.minWidth = '';
                });
            }
        }

        async function fetchData() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const titleContainer = document.getElementById('title-container');
            const tableContainer = document.getElementById('table-container');
            const lastUpdatedEl = document.getElementById('last-updated');
            const table = document.getElementById('data-table');

            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            titleContainer.innerHTML = '';
            tableContainer.style.display = 'none';
            table.innerHTML = '';

            let apiData = null;

            try {
                const response = await fetch(API_ENDPOINT, { method: 'GET', headers: { 'Accept': 'application/json' } });
                if (!response.ok) throw new Error(`Server error ${response.status}`);
                const result = await response.json();
                apiData = result.message?.data || result.data;
                if (!apiData || !apiData.headers) throw new Error("Invalid or empty data received.");
            } catch (err) {
                loadingEl.style.display = 'none';
                errorEl.innerHTML = `<strong>डेटा लोड करण्यात त्रुटी:</strong><br>${err.message}`;
                errorEl.style.display = 'block';
                console.error("Fetch error:", err);
                return;
            }

            const data = apiData;

            // Title Rows
            if (data.title_rows && data.title_rows.length > 0) {
                data.title_rows.forEach((row, index) => {
                    const text = row.filter(cell => cell && cell.trim()).join(' ').trim();
                    if (text) {
                        const div = document.createElement('div');
                        div.className = index === 0 ? 'title-heading' : 'subtitle-heading';
                        div.textContent = text;
                        titleContainer.appendChild(div);
                    }
                });
            }

            // Calculate columns
            let totalColumns = Math.max(
                data.headers?.length || 0,
                ...(data.rows?.map(r => r.length) || [0])
            ) || 11;

            // Build table
            if (data.headers?.length > 0) {
                const tr = document.createElement('tr');
                padRow(data.headers, totalColumns).forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text || '';
                    tr.appendChild(th);
                });
                table.appendChild(tr);
            }

            if (data.rows?.length > 0) {
                data.rows.forEach(row => {
                    const tr = document.createElement('tr');
                    padRow(row, totalColumns).forEach(text => {
                        const td = document.createElement('td');
                        td.textContent = text || '';
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
            } else {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = totalColumns;
                td.textContent = 'सध्या कोणतीही निविदा उपलब्ध नाही.';
                td.style.textAlign = 'center';
                td.style.fontStyle = 'italic';
                tr.appendChild(td);
                table.appendChild(tr);
            }

            setResponsiveColumnWidths(table, totalColumns);
            window.addEventListener('resize', () => setResponsiveColumnWidths(table, totalColumns));

            loadingEl.style.display = 'none';
            tableContainer.style.display = 'block';

            const now = new Date();
            lastUpdatedEl.textContent = `शेवटचे अपडेट: ${now.toLocaleDateString('mr-IN')} ${now.toLocaleTimeString('mr-IN')}`;
        }

        document.addEventListener('DOMContentLoaded', fetchData);
        document.getElementById('refresh-btn').addEventListener('click', fetchData);
    </script>
</body>
</html>